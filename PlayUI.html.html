<!DOCTYPE html>
<html>

<head>
  <base target="_top" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      padding: 20px;
      //max-width: 400px;
      margin: auto;
    }

    h3 {
      text-align: center;
      color: #333;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
      color: #444;
    }

    select,
    button {
      margin-top: 5px;
      padding: 6px 10px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }

    button {
      margin-top: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }

    button:hover {
      background-color: #0056b3;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      padding: 6px 0;
      border-bottom: 1px solid #ccc;
    }

    .result-box {
      margin-top: 20px;
      padding: 12px;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.1);
    }

    .highlight {
      color: green;
      font-weight: bold;
    }

    .turnover {
      color: red;
      font-weight: bold;
    }

    ul {
      padding-left: 20px;
      margin-top: 5px;
    }

    .section-title {
      margin-top: 15px;
      font-weight: bold;
      text-decoration: underline;
    }

    /* FIELD STUFF */
    #field3D {
      position: relative;
      width: 1200px;
      height: 180px;
      //width: 100%;
      //height: 140px; /* reduce height for balance */
      transform: rotateX(45deg);
      /* no perspective here, moved to wrapper */
      margin: 30px auto;
      background: linear-gradient(to right, #007a33 0%, #006622 100%);
      border: 3px solid #333;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      //transform: perspective(1000px) rotateX(45deg);
      transform-style: preserve-3d;
      overflow: hidden;
    }

    /* Yard lines and labels */
    .yardline {
      position: absolute;
      bottom: 0;
      width: 1px;
      height: 100%;
      background-color: white;
      text-align: center;
      font-size: 16px;
      color: white;
    }

    /* Drive line (white) and last play (black) use same base style */
    .driveSegment {
      position: absolute;
      top: 50%;
      height: 6px;
      background-color: white;
      border-radius: 0px;
      z-index: 2;
    }

    #field3D {
      z-index: 3;
    }

    /* Dot at start of play */
    .last-dot,
    .drive-dot {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: black;
      border-radius: 50%;
      top: -2px;
      left: 0;
      z-index: 2;
      /* below arrow, above base */
      opacity: 1;
    }

    .drive-dot {
      background-color: white;
    }

    /* Arrow that moves with the last play */
    .drive-arrow {
      position: absolute;
      font-size: 19px;
      color: black;
      left: 0;
      top: -10px;
      /* raise the arrow slightly above the line */
      opacity: 1;
      z-index: 3;
      /* ensure it‚Äôs above all segments */
      transition: left 1.4s ease, opacity 0.5s ease;
    }

    .field-wrapper {
      width: 100%;
      max-width: 1600px;
      margin: 20px auto;
      overflow-x: auto;
      overflow-y: hidden;
      perspective: 1000px;
    }
  </style>
</head>

<body>
  <h3>üèà Run a Play</h3>

  <label>Possession:
        <span id="possession">Loading...</span>
      </label>
  <label>Select Player:
      <select id="playerDropdown"></select>
    </label>

  <div class="info-row">
    <span><strong>Down:</strong> <span id="down">...</span></span>
    <span><strong>Distance:</strong> <span id="distance">...</span></span>
  </div>
  <div class="info-row">
    <span><strong>Ball On:</strong> <span id="ballOn">...</span></span>
  </div>

  <button onclick="runPlay()">‚ñ∂Ô∏è Run Play</button>
  <button onclick="nextDrive()">üîÅ Next Drive</button>
  <div class="field-wrapper">
    <div id="field3D">
      <!-- Yard lines -->
      <div class="yardline" style="left: 100px;"></div>
      <div class="yardline" style="left: 200px;">10</div>
      <div class="yardline" style="left: 300px;">20</div>
      <div class="yardline" style="left: 400px;">30</div>
      <div class="yardline" style="left: 500px;">40</div>
      <div class="yardline" style="left: 600px;">50</div>
      <div class="yardline" style="left: 700px;">40</div>
      <div class="yardline" style="left: 800px;">30</div>
      <div class="yardline" style="left: 900px;">20</div>
      <div class="yardline" style="left: 1000px;">10</div>
      <div class="yardline" style="left: 1100px;"></div>
      <div class="yardline" style="left: 1200px;"></div>
      <!-- Drive Line (white line showing entire drive so far) -->
      <div id="drive3D" class="driveSegment">
        <div class="drive-dot"></div>
      </div>
      <!-- Last play marker (black line, dot, and arrow) -->
      <div id="lastPlayMarker" class="driveSegment">
        <div class="drive-arrow">‚û§</div>
        <div class="last-dot"></div>
      </div>
      <canvas id="arcCanvas" width="1200" height="180"
        style="position: absolute; top: 0; left: 0; z-index: 1;"></canvas>
      <div id="catchPoint"
        style="position: absolute;  font-size: 22px;  color: black;  opacity: 0;  z-index: 4;  pointer-events: none;  transition: opacity 0.5s ease;">
      </div>
    </div>
  </div>

  <div id="result" class="result-box"></div>

  <script>
    let state = {};
      let prevPrev = 0;
      let driveStart = 0;
      let currentYard = 0;

      function refreshUI() {
        google.script.run.withSuccessHandler(function(gameState) {
          state = gameState;
          document.getElementById("down").innerText = gameState.Down;
          document.getElementById("distance").innerText = gameState.Distance;
          document.getElementById("ballOn").innerText = formatBallOn(gameState.BallOn);
          document.getElementById("possession").innerText = gameState.Possession;
          currentYard = gameState.BallOn;
          prevYard = gameState.Previous;
          driveStart = gameState.DriveStart;
          loadPlayers(gameState.Possession);
          show3DDrive(driveStart, prevYard, currentYard);
        }).getGameState();
      }

      function formatBallOn(yard) {
        yard = parseInt(yard, 10);
        if (yard <= 50) return "own " + yard;
        return "opp " + (100 - yard);
      }

      function loadPlayers(team) {
        google.script.run.withSuccessHandler(function(names) {
          const dropdown = document.getElementById("playerDropdown");
          dropdown.innerHTML = "";
          names.forEach(function(name) {
            const option = document.createElement("option");
            option.value = name;
            option.text = name;
            dropdown.appendChild(option);
          });
        }).getPlayerNames();
      }

      function runPlay() {
        const player = document.getElementById("playerDropdown").value;
        if (!player) return;

        google.script.run.withSuccessHandler(function(result) {
          let output = `<strong>${result.name}</strong> ran for <strong>${result.yards} yards</strong><br/>`;
          if (result.touchdown) output += `<p class="highlight">üèà TOUCHDOWN!</p>`;
          if (result.turnover) output += `<p class="turnover">‚ùå Turnover on Downs</p>`;
          output += `<br/>Ball On: ${formatBallOn(result.ballOn)}<br/>Down: ${result.down}<br/>Distance: ${result.distance}<br/>`;

          output += `<div class="section-title">Modifiers Used:</div><ul>`;
          result.modLog.forEach(m => {
            output += `<li>${m}</li>`;
          });
          output += `</ul>`;

          if (result.fatigueDrop) {
            output += `<div class="section-title">Fatigue Effect:</div><ul>`;
            for (const [key, val] of Object.entries(result.fatigueDrop)) {
              if (val !== 0) output += `<li>${key}: -${val}</li>`;
            }
            output += `</ul>`;
          }

          document.getElementById("result").innerHTML = output;
          refreshUI();
        }).runPlayForPlayer(player);
      }

      function nextDrive() {
        google.script.run.withSuccessHandler(refreshUI).switchPossession;
      }

      function show3DDrive(startYard, prevYard, currentYard, playType = 'run', passComplete = true) {
        const drivePX = (startYard * 10) + 100;
        const prevPX = (prevYard * 10) + 100;
        const currPX = (currentYard * 10) + 100;
        const drive = document.getElementById("drive3D");
        drive.style.left = `${drivePX}px`;
        drive.style.width = `${prevPX - drivePX}px`;
        const lastPlay = document.getElementById("lastPlayMarker");
        const lastDot = lastPlay.querySelector(".last-dot");
        const arrow = lastPlay.querySelector(".drive-arrow");
        const catchPoint = document.getElementById("catchPoint");
        catchPoint.style.opacity = 0; // Hide previous catch point immediately
        // Fade out old marker
        lastPlay.style.opacity = lastDot.style.opacity = arrow.style.opacity = 0;
        setTimeout(() => {
          lastPlay.style.transition = "none";
          lastPlay.style.backgroundColor = playType === 'pass' ? 'transparent' : 'black';
          lastPlay.style.width = `0px`;
          lastPlay.style.left = `${prevPX}px`;
          lastPlay.style.opacity = 1;
          lastDot.style.left = `0px`;
          lastDot.style.opacity = 1;
          arrow.style.left = `0px`;
          arrow.style.opacity = 1;
          if (playType === 'run') {
            lastPlay.style.top = `50%`;
            lastPlay.style.height = `6px`;
            arrow.style.top = `-10px`;
            setTimeout(() => {
              lastPlay.style.transition = "width 1.4s ease";
              arrow.style.transition = "left 1.4s ease";
              lastPlay.style.width = `${currPX - prevPX}px`;
              arrow.style.left = `${(currPX - prevPX) - 10}px`;
            }, 50);
          } else {
            lastDot.style.opacity = arrow.style.opacity = 0;
            drawPassArc(prevPX, currPX, passComplete);
          }
        }, 400);
      }
      function drawPassArc(x0, x1, passComplete = true) {
        const canvas = document.getElementById("arcCanvas");
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const midX = (x0 + x1) / 2;
        const y = canvas.height * 0.45;
        const peakHeight = Math.min(120, Math.max(50, ((x1 - x0) / 10) * 6));
        ctx.setLineDash([10, 5]);
        ctx.lineWidth = 2;
        ctx.strokeStyle = "black";
        ctx.lineCap = "round";
        let offset = 0;
        let startTime = null;
        function animate(timestamp) {
          if (!startTime) startTime = timestamp;
          const elapsed = timestamp - startTime;
          offset -= 2;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.setLineDash([10, 5]);
          ctx.lineDashOffset = offset;
          ctx.beginPath();
          ctx.moveTo(x0, y);
          ctx.quadraticCurveTo(midX, y - peakHeight, x1, y);
          ctx.stroke();
          if (elapsed < 3000) {
            requestAnimationFrame(animate);
          } else {
            showCatchPoint(x1, y, passComplete);
          }
        }
        requestAnimationFrame(animate);
      }
      function showCatchPoint(x, y, complete = true) {
        const catchPoint = document.getElementById("catchPoint");
        catchPoint.innerText = complete ? "‚û§" : "‚úñ";
        catchPoint.style.left = `${x - 8}px`;
        catchPoint.style.top = `${y - 20}px`;
        catchPoint.style.opacity = 0;
        // Fade in and stay
        setTimeout(() => {
          catchPoint.style.transition = "opacity 0.8s ease";
          catchPoint.style.opacity = 1;
        }, 100);
      }


      // On load
      refreshUI();
  </script>
</body>

</html>